<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redis Pub/Sub Real-time Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .log-entry.notification {
            border-left-color: #28a745;
        }
        .log-entry.chat {
            border-left-color: #ffc107;
        }
        .log-entry.error {
            border-left-color: #dc3545;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Redis Pub/Sub Real-time Demo</h1>
    
    <div class="container">
        <!-- Message Queue Panel -->
        <div class="panel">
            <h2>ðŸ“¨ Message Queue</h2>
            <div class="form-group">
                <label for="messageContent">Message Content:</label>
                <input type="text" id="messageContent" placeholder="Enter message content">
            </div>
            <div class="form-group">
                <label for="messagePriority">Priority:</label>
                <select id="messagePriority">
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label for="userId">User ID (optional):</label>
                <input type="text" id="userId" placeholder="Enter user ID">
            </div>
            <button onclick="createMessage()">Send Message</button>
            <button onclick="processMessage()">Process Next</button>
            <button onclick="getQueueStats()" style="background: #6c757d;">Get Stats</button>
        </div>

        <!-- Chat Panel -->
        <div class="panel">
            <h2>ðŸ’¬ Chat System</h2>
            <div class="form-group">
                <label for="channelName">Channel Name:</label>
                <input type="text" id="channelName" placeholder="Enter channel name">
            </div>
            <div class="form-group">
                <label for="chatMessage">Chat Message:</label>
                <input type="text" id="chatMessage" placeholder="Enter chat message">
            </div>
            <div class="form-group">
                <label for="senderId">Sender ID:</label>
                <input type="text" id="senderId" placeholder="Enter sender ID">
            </div>
            <button onclick="createChannel()">Create Channel</button>
            <button onclick="sendChatMessage()">Send Message</button>
            <button onclick="getChatStats()" style="background: #6c757d;">Get Stats</button>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div class="panel">
        <h2>ðŸ”” System Notifications</h2>
        <div class="form-group">
            <label for="notificationMessage">Notification Message:</label>
            <input type="text" id="notificationMessage" placeholder="Enter notification message">
        </div>
        <div class="form-group">
            <label for="alertLevel">Alert Level:</label>
            <select id="alertLevel">
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
                <option value="critical">Critical</option>
            </select>
        </div>
        <button onclick="broadcastNotification()">Broadcast Notification</button>
        <button onclick="getNotificationStats()" style="background: #6c757d;">Get Stats</button>
    </div>

    <!-- Statistics Dashboard -->
    <div class="panel">
        <h2>ðŸ“Š Real-time Statistics</h2>
        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <span class="stat-number" id="totalMessages">0</span>
                <span class="stat-label">Total Messages</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="onlineUsers">0</span>
                <span class="stat-label">Online Users</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="activeChannels">0</span>
                <span class="stat-label">Active Channels</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="pendingMessages">0</span>
                <span class="stat-label">Pending Messages</span>
            </div>
        </div>
        <button onclick="refreshStats()">Refresh Stats</button>
        <button onclick="clearLog()" class="danger">Clear Log</button>
    </div>

    <!-- Activity Log -->
    <div class="panel">
        <h2>ðŸ“‹ Activity Log</h2>
        <div class="log" id="activityLog">
            <div class="log-entry">System initialized - Ready for testing!</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentChannelId = null;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showStatus(message, isError = false) {
            // Remove existing status
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }

            const status = document.createElement('div');
            status.className = `status ${isError ? 'error' : 'success'}`;
            status.textContent = message;
            document.body.appendChild(status);

            setTimeout(() => status.remove(), 3000);
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'API call failed');
                }

                return data;
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                showStatus(`Error: ${error.message}`, true);
                throw error;
            }
        }

        async function createMessage() {
            const content = document.getElementById('messageContent').value;
            const priority = document.getElementById('messagePriority').value;
            const userId = document.getElementById('userId').value;

            if (!content) {
                showStatus('Please enter message content', true);
                return;
            }

            try {
                const response = await apiCall('/messages', 'POST', {
                    content,
                    priority,
                    userId: userId || undefined
                });

                log(`Message created: ${response.data.id} (${priority})`, 'notification');
                showStatus('Message created successfully!');
                document.getElementById('messageContent').value = '';
                refreshStats();
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function processMessage() {
            try {
                const response = await apiCall('/messages/next');
                
                if (response.data.message) {
                    log(`Processing message: ${response.data.message.id}`, 'notification');
                    
                    // Simulate processing time
                    setTimeout(async () => {
                        try {
                            await apiCall(`/messages/${response.data.message.id}/complete?success=true`, 'PUT');
                            log(`Message completed: ${response.data.message.id}`, 'notification');
                            refreshStats();
                        } catch (error) {
                            // Error already logged
                        }
                    }, 2000);
                } else {
                    log('No messages in queue', 'info');
                }
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function createChannel() {
            const name = document.getElementById('channelName').value;
            const creatorId = document.getElementById('senderId').value || 'demo_user';

            if (!name) {
                showStatus('Please enter channel name', true);
                return;
            }

            try {
                const response = await apiCall(`/chat/channels?creatorId=${creatorId}`, 'POST', {
                    name,
                    description: `Demo channel: ${name}`,
                    isPrivate: false
                });

                currentChannelId = response.data.id;
                log(`Channel created: ${name} (${currentChannelId})`, 'chat');
                showStatus('Channel created successfully!');
                document.getElementById('channelName').value = '';
                refreshStats();
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function sendChatMessage() {
            const message = document.getElementById('chatMessage').value;
            const senderId = document.getElementById('senderId').value || 'demo_user';

            if (!message) {
                showStatus('Please enter chat message', true);
                return;
            }

            if (!currentChannelId) {
                showStatus('Please create a channel first', true);
                return;
            }

            try {
                const response = await apiCall(`/chat/channels/${currentChannelId}/messages?senderId=${senderId}`, 'POST', {
                    message
                });

                log(`Chat message sent: ${message}`, 'chat');
                showStatus('Message sent successfully!');
                document.getElementById('chatMessage').value = '';
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function broadcastNotification() {
            const message = document.getElementById('notificationMessage').value;
            const alertLevel = document.getElementById('alertLevel').value;

            if (!message) {
                showStatus('Please enter notification message', true);
                return;
            }

            try {
                await apiCall('/notifications/system/broadcast', 'POST', {
                    alertLevel,
                    message,
                    details: { source: 'demo', timestamp: new Date().toISOString() }
                });

                log(`System notification broadcasted: ${message} (${alertLevel})`, 'notification');
                showStatus('Notification broadcasted successfully!');
                document.getElementById('notificationMessage').value = '';
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function refreshStats() {
            try {
                const [queueStats, chatStats, notificationStats] = await Promise.all([
                    apiCall('/messages/stats'),
                    apiCall('/chat/stats'),
                    apiCall('/notifications/stats')
                ]);

                document.getElementById('totalMessages').textContent = queueStats.stats.totalMessages;
                document.getElementById('pendingMessages').textContent = queueStats.stats.pendingMessages;
                document.getElementById('onlineUsers').textContent = chatStats.data.onlineUsers;
                document.getElementById('activeChannels').textContent = chatStats.data.totalChannels;

                log('Statistics refreshed', 'info');
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function getQueueStats() {
            try {
                const response = await apiCall('/messages/stats');
                log(`Queue Stats: ${JSON.stringify(response.stats, null, 2)}`, 'info');
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function getChatStats() {
            try {
                const response = await apiCall('/chat/stats');
                log(`Chat Stats: ${JSON.stringify(response.data, null, 2)}`, 'info');
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        async function getNotificationStats() {
            try {
                const response = await apiCall('/notifications/stats');
                log(`Notification Stats: ${JSON.stringify(response.data, null, 2)}`, 'info');
            } catch (error) {
                // Error already logged in apiCall
            }
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '<div class="log-entry">Log cleared</div>';
        }

        // Auto-refresh stats every 10 seconds
        setInterval(refreshStats, 10000);

        // Initial stats load
        refreshStats();

        log('Demo interface loaded! Start testing your Redis Pub/Sub system.', 'info');
    </script>
</body>
</html>